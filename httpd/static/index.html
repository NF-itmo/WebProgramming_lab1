<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" href="assets/img/logo.ico" type="image/x-icon"/>
    <title>Web lab1</title>

    <script src="./js/net/ajax.js"></script>
    <script src="./js/plot.js"></script>
    <script src="./js/historyTable.js"></script>
    <script src="./js/error.js"></script>
    
    <style>
        :root {
            /* Цветовая палитра в OKLCH */
            --bg-primary: oklch(15% 0.06 260);
            --bg-secondary: oklch(25% 0.06 260);
            --bg-tertiary: oklch(35% 0.06 260);

            --text-primary: oklch(95% 0.02 260);
            --text-secondary: oklch(75% 0.02 260);

            --accent-primary: oklch(65% 0.22 260);
            --accent-secondary: oklch(55% 0.18 260);

            --border-color: oklch(30% 0.05 260);
            --shadow: 0 4px 12px oklch(0% 0 0 / 0.3);

            --btn-primary: oklch(55% 0.18 50);
            --btn-secondary: oklch(50% 0.18 50);

            --svg-axis-primary: oklch(75% 0.04 260);
            --svg-fill-area: oklch(52% 0.07 200);

            --error-bg: oklch(55% 0.15 19);

            /* Всякое разное */
            --btn-active-translateY: -2px;

            font-size: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Дефолтные настройки стиля текста */
            font-family: 'fantasy;', sans-serif;
            color: var(--text-secondary);
            line-height: 1.6;

            background: var(--bg-primary);
            
            min-height: 100vh;
            padding: 20px;

            /* Расположение элементов */
            display: grid;
            justify-items: center;
            
            user-select: none;
        }

            .container {
                max-width: 800px;
                width: 100%;
                padding: 30px;

                background: var(--bg-secondary);

                border-radius: 12px;

                box-shadow: var(--shadow);
            }

                .header {
                    text-align: center;
                    
                    padding-bottom: 10px;
                    margin-bottom: 10px;

                    border-bottom: 2px solid var(--border-color);
                }

                .header h1 {
                    color: var(--text-primary);
                    font-size: 2.2rem;
                    font-weight: 300;
                }        

                .header h2 {
                    color: var(--text-secondary);
                    font-size: 1.2rem;
                    font-weight: 500;
                }    

            .graph-container {
                display: grid;
                justify-items: center;
            }

            .form-container {
                padding: 10px;
            }

                #form-svg-placeholder {
                    color: var(--accent-primary);
                    font-size: 1.4rem;
                    text-align: center;
                    margin-bottom: 10px;
                }

                .form-grid {
                    display: grid;
                    grid-template-columns: 1fr 3fr;

                    background: var(--bg-tertiary);    

                    border-radius: 8px;
                    overflow: hidden;
                }        

                    .form-row {
                        display: contents;
                    }        

                        .row-label {
                            padding: 20px;
                            background: oklch(30% 0.06 260);    

                            display: flex;
                            align-items: center;    

                            font-weight: 600;
                            color: var(--accent-primary);
                            border-bottom: 1px solid var(--border-color);
                        }    
                            .row-label p {
                                color: var(--text-secondary);
                            }    

                        .row-input {
                            padding: 20px;
                            background: var(--bg-tertiary);    

                            display: inline-flex;
                            gap: 3%;    

                            border-bottom: 1px solid var(--border-color);
                        }
                            .input-group {
                                display: flex;
                                flex-direction: column;    

                                align-items: center;    

                                gap: 2px;
                            }

                                input, label {
                                    cursor: pointer;
                                }
                                input[type="radio"] {
                                    width: 18px;
                                    height: 18px;

                                    accent-color: var(--accent-primary);
                                }    

                                input[type="number"] {
                                    width: 100%;
                                    max-width: 200px;
                                    padding: 12px;

                                    border: 2px solid var(--border-color);
                                    border-radius: 6px;

                                    background: var(--bg-secondary);

                                    color: var(--text-primary);
                                    font-size: 16px;

                                    transition: border-color 0.3s ease;
                                }

                                input[type="number"]:focus {
                                    outline: none;
                                    border-color: var(--accent-primary);
                                }

                                label {
                                    color: var(--text-secondary);
                                    transition: color 0.3s ease;
                                }

                                label:hover {
                                    color: var(--text-primary);
                                }

                                input:checked ~ label {
                                    color: var(--text-primary);
                                }
                                input:hover ~ label {
                                    color: var(--text-primary);
                                }

            .submit-container {
                display: grid;
                grid-template-columns: 1fr;
                
                margin-top: 10px;
            }    

                .submit-btn {
                    padding: 16px;

                    background: var(--accent-primary);
                    
                    font-size: 1rem;
                    font-weight: 600;
                    color: var(--text-primary);

                    border: none;
                    border-radius: 8px;

                    cursor: pointer;

                    transition: all 0.3s ease;
                }    

                .submit-btn:hover {
                    background: var(--accent-secondary);
                    transform: translateY(var(--btn-active-translateY));
                    box-shadow: var(--shadow);
                }

            .container {
                animation: containerFadeIn 0.6s ease-out;
            }

            /* Адаптивность */
            @media (max-width: 768px) {
                .form-grid {
                    grid-template-columns: 1fr;
                }
                
                .form-label {
                    padding: 15px;
                    border-bottom: none;
                    background: oklch(25% 0.06 260);
                }
                
                .form-input {
                    padding: 15px 15px 20px 15px;
                    border-bottom: 1px solid var(--border-color);
                }
                
                .form-row:last-child .form-input {
                    border-bottom: none;
                }
                
                input[type="number"] {
                    max-width: 100%;
                }
            }    

            @media (max-width: 480px) {
                .container {
                    padding: 20px;
                }
                
                .header h1 {
                    font-size: 1.8rem;
                }
                
                .input-group {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 8px;
                }
            }

        /* Стили для таблицы истории */
        .history-section {
            margin-top: 30px;
        }

            .history-title {
                text-align: center;    

                color: var(--text-primary);
                font-size: 1.4rem;    

                margin-bottom: 15px;
            }

            .history-table {
                width: 100%;

                display: block;

                background: var(--bg-tertiary);

                border-collapse: collapse;
                border-radius: 8px;
                overflow: hidden;

                overflow-x: auto;

                box-shadow: var(--shadow);
            }

                .history-table th, .history-table td {
                    width: 100%;
                    padding: 15px;
                    text-align: left;
                    border-bottom: 1px solid var(--border-color);
                }        

                .history-table th {
                    background: oklch(30% 0.06 260);

                    color: var(--text-secondary);

                    font-weight: 600;
                    position: sticky;
                    top: 0;
                }        

                .history-table tr:last-child td {
                    border-bottom: none;
                }        

                .history-table tr:hover {
                    background: oklch(40% 0.06 260);
                }        

                .history-table td {
                    color: var(--text-secondary);
                }

            .empty-history {
                text-align: center;
                color: var(--text-secondary);
                font-style: italic;

                padding: 20px 10px 5px 10px;
            }

        .action-buttons {
            display: grid;
            justify-content: center;

            margin-top: 20px;
        }

            .clear-btn {
                padding: 12px 24px;

                background: var(--btn-primary);

                color: var(--text-primary);

                border: none;
                border-radius: 6px;

                cursor: pointer;

                transition: all 0.3s ease;
            }    

            .clear-btn:hover {
                background: var(--btn-secondary);

                transform: translateY(var(--btn-active-translateY));
            }

        /* Сообщение об ошибке */
        .error-message {
            position: fixed;
            bottom: 20px;
            right: 20px;

            background-color: var(--error-bg);
            color: var(--text-primary);

            padding: 15px 20px;

            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);

            z-index: 1000;

            max-width: 350px;
            
            animation: errorSlideIn 0.3s ease-out, errorFadeOut 0.5s ease-in 4.5s forwards;
        }
        
        /* Адаптивность */
        @media (max-width: 968px) {
            .container {
                min-width: 95%;
            }
            
            .history-table {
                font-size: 14px;
            }
            
            .history-table th,
            .history-table td {
                padding: 10px;
            }
        }

        @media (max-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 550px) {
            .header h1 {
                font-size: 1.8rem;
            }
        }

        /* Анимации */
        @keyframes containerFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }    

        @keyframes errorSlideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes errorFadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Шапка с ФИО, номером группы и вариантом-->
        <header class="header">
            <h1>Решетников Сергей Евгеньевич</h1>
            <h2>Группа: P3108</h2>
            <h2>Вариант: 467233</h2>
        </header>

        <div class="graph-container">
             <svg height="200px" width="200px" id="graph-svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                 <!-- fill -->     

                 <rect x="100" y="20" width="40" height="80" class="svg-fill-area"/> <!-- 1st quoter -->
                 <polygon points="100,100 180,100 100,140" class="svg-fill-area"/> <!-- 2nd quoter -->
                 <path d="M 100 100 L 20 100 A80,80 0 0,1 100,20 Z" class="svg-fill-area"/> <!-- 4th quoter -->     

                 <!-- axes -->     

                 <g> <!-- X axis -->
                     <line class="svg-cord-line" x1="0" x2="200" y1="100" y2="100"></line>
                     <polygon class="svg-cord-arrow" points="200,100 190,104 190,96"></polygon>
                 </g>
                 <g> <!-- Y axis -->
                     <line class="svg-cord-line" x1="100" x2="100" y1="0" y2="200"></line>
                     <polygon class="svg-cord-arrow" points="100,0 96,10 104,10"></polygon>
                 </g>     

                 <!-- captions -->     

                 <g> <!-- X axis -->
                     <text class="svg-caption" x="175" y="90">R</text>
                     <text class="svg-caption" x="132" y="90">R/2</text>
                     <text class="svg-caption" x="48" y="90">-R/2</text>
                     <text class="svg-caption" x="15" y="90">-R</text>     

                     <text class="svg-caption" x="190" y="120">X</text>
                 </g>
                 <g> <!-- Y axis -->
                     <text class="svg-caption" x="110" y="25">R</text>
                     <text class="svg-caption" x="110" y="65">R/2</text>
                     <text class="svg-caption" x="110" y="143">-R/2</text>
                     <text class="svg-caption" x="110" y="183">-R</text>     

                     <text class="svg-caption" x="85" y="10">Y</text>
                 </g>     

                 <!-- lines on cords --> 

                 <g> <!-- X axis -->
                     <line class="svg-cord-line" x1="180" x2="180" y1="105" y2="95"></line>
                     <line class="svg-cord-line" x1="140" x2="140" y1="105" y2="95"></line>
                     <line class="svg-cord-line" x1="60" x2="60" y1="105" y2="95"></line>
                     <line class="svg-cord-line" x1="20" x2="20" y1="105" y2="95"></line>
                 </g>
                 <g> <!-- Y axis -->
                     <line class="svg-cord-line" x1="105" x2="95" y1="180" y2="180"></line>
                     <line class="svg-cord-line" x1="105" x2="95" y1="140" y2="140"></line>
                     <line class="svg-cord-line" x1="105" x2="95" y1="60" y2="60"></line>
                     <line class="svg-cord-line" x1="105" x2="95" y1="20" y2="20"></line>
                 </g>
                 
                 <style>
                    .svg-cord-line {
                        stroke: var(--svg-axis-primary);
                    }
                    .svg-cord-arrow {
                        fill: var(--svg-axis-primary);
                    }     

                    .svg-caption {
                        fill: var(--text-secondary);
                        font-size: 12px;
                    }     

                    .svg-fill-area {
                        fill: var(--svg-fill-area);
                        fill-opacity: 0.7;
                    }

                    .point-on-graph {
                       fill: var(--accent-primary);
                    }
                 </style>
             </svg>
        </div>

        <!-- Форма с Grid вёрсткой -->
        <div class="form-container">
            <form id="graph-test-form">
                <div class="form-grid">
                    <!-- Первая строка -->
                    <div class="form-row">
                        <div class="row-label">
                            <p>Выберите X:</p>
                        </div>
                        <div class="row-input">
                            <div class="input-group">
                                <input type="radio" id="X-4" name="X" value="-4">
                                <label for="X-4">-4</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X-3" name="X" value="-3">
                                <label for="X-3">-3</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X-2" name="X" value="-2">
                                <label for="X-2">-2</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X-1" name="X" value="-1">
                                <label for="X-1">-1</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X0" name="X" value="0" checked>
                                <label for="X0">0</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X1" name="X" value="1">
                                <label for="X1">1</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X2" name="X" value="2">
                                <label for="X2">2</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X3" name="X" value="3">
                                <label for="X3">3</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="X4" name="X" value="4">
                                <label for="X4">4</label>
                            </div>
                        </div>
                    </div>

                    <!-- Вторая строка -->
                    <div class="form-row">
                        <div class="row-label">
                            <p>Выберете R:</p>
                        </div>
                        <div class="row-input">
                            <div class="input-group">
                                <input type="radio" id="R1" name="R" value="1">
                                <label for="R1">1</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="R1.5" name="R" value="1.5">
                                <label for="R1.5">1.5</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="R2" name="R" value="2" checked>
                                <label for="R2">2</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="R2.5" name="R" value="2.5">
                                <label for="R2.5">2.5</label>
                            </div>
                            <div class="input-group">
                                <input type="radio" id="R3" name="R" value="3">
                                <label for="R3">3</label>
                            </div>
                        </div>
                    </div>

                    <!-- Третья строка -->
                    <div class="form-row">
                        <div class="row-label">
                            <p>Выберете Y:</p>
                        </div>
                        <div class="row-input">
                            <input type="number" id="Y" name="Y" min="-3" max="5" value="0" 
                                   placeholder="Введите Y" required pattern="^(-?[1-9]\d*(\.\d+)?)|(^-?0(\.\d*[1-9]))$">
                        </div>
                    </div>
                </div>
                
                <div class="submit-container">
                    <button type="submit" class="submit-btn">Отправить данные</button>
                </div>
            </form>
        </div>

        <!-- Таблица с историей данных -->
        <div class="history-section">
            <h3 class="history-title">История введенных данных</h3>
            <div class="history-table-container">
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Дата и время</th>
                            <th>Затраченное время</th>
                            <th>X</th>
                            <th>Y</th>
                            <th>R</th>
                            <th>Результат</th>
                        </tr>
                    </thead>
                    <tbody id="historyTableBody">
                        <!-- Данные будут добавляться через JavaScript -->
                    </tbody>
                </table>
                <div id="emptyHistory" class="empty-history">
                    История пуста. Заполните форму, чтобы добавить данные.
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="clear-btn" onclick="clearHistory()">Очистить историю</button>
            </div>
        </div>
    </div>

    <script>
        const plot = new Plot("graph-svg");
        const history = new HistoryTable("historyTableBody");
        const error = new ErrorFactory("error-message")

        // Обработчик отправки формы
        document.getElementById('graph-test-form').addEventListener('submit', function (e) {
            e.preventDefault(); // Отключаем дефолтное поведение
            
            // Получаем все значения
            const X = Number(document.querySelector('input[name="X"]:checked').value);
            const R = Number(document.querySelector('input[name="R"]:checked').value);
            const Y = Number(document.getElementById('Y').value);

            sendAJAXRequest("GET", "/fcgi/", {"x": X, "y": Y, "r": R})
                .then(
                    result => {testHandler(result, X, Y, R)},
                    result => {errorHandler(result)}
                );
            
            this.reset();
        });

        const errorHandler = (result) => {
            const JSONResponce = JSON.parse(result.response);
            error.showError(`Ошибка: ${JSONResponce.error} (${result.status})`)
        }

        const testHandler = (result, X, Y, R) => {
            const JSONResponce = JSON.parse(result.response);
                        
            // Обновляем таблицу
            history.addHistoryItem(
                new Date().toISOString(),
                JSONResponce.elapsedTimeNs,
                X,
                Y,
                R,
                JSONResponce.result
            )

            // Обновляем график
            plot.addPoint(
                ...convertInputCordsToSvgCords(X, Y, R),
                3,
                "point-on-graph"
            );  
        }

        // Функция для очистки истории
        const clearHistory = () => {
            if (confirm('Вы уверены, что хотите очистить всю историю?')) {
                history.clear();
                plot.clear();
            }
        }

        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            // placeholder
        });
    </script>
</body>
</html>